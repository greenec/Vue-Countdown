<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Countdown</title>

    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" />

    <style>
        [v-cloak] {
            display: none;
        }

        body {
            text-align: center;
            background: #18BC9C;
            font-family: sans-serif;
        }

        h1 {
            color: #35495E;
        }

        #countdown .time-card {
            color: #fff;
            background: #00A383;
            border-radius: 3px;
            font-size: 30px;
            padding: 10px;
        }

            #countdown .time-card > .tc-value {
                padding: 5px;
                border-radius: 3px;
                background: #35495E;
            }

            #countdown .time-card > .tc-description {
                margin-top: 10px;
                font-size: 15px;
            }

        /* Override default bootstrap colors */
        .btn-primary {
            background-color: #35495E;
            border-color: #35495E;
        }

            .btn-primary:hover,
            .btn-primary:not(:disabled):not(.disabled):active {
                background-color: #1C3045;
                border-color: #1C3045;
            }

        .list-group-item.active {
            background-color: #35495E;
            border-color: #35495E;
        }

        /* Reduce padding for columns on mobile devices */
        .col-3 {
            padding-left: 2.5px;
            padding-right: 2.5px;
        }

            .col-3:first-child {
                padding-left: 5px;
            }

            .col-3:last-child {
                padding-right: 5px;
            }

        /* Increase value bubble on larger screens */
        @media (min-width: 768px) {
            #countdown .time-card > .tc-value {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-5 mb-4">Countdown</h1>

        <!-- Active countdown display -->
        <div id="countdown" v-cloak>
            <div v-if="loading">
                Loading...
            </div>
            <div class="row" v-else-if="timeData.total > 0">
                <div class="offset-md-2 col-md-2 col-3">
                    <div class="time-card">
                        <span class="tc-value">
                            {{ timeData.days | padTimeComponent }}
                        </span>
                        <div class="tc-description">
                            {{ timeData.days | pluralize('Day') }}
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-3">
                    <div class="time-card">
                        <span class="tc-value">
                            {{ timeData.hours | padTimeComponent }}
                        </span>
                        <div class="tc-description">
                            {{ timeData.hours | pluralize('Hour') }}
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-3">
                    <div class="time-card">
                        <span class="tc-value">
                            {{ timeData.minutes | padTimeComponent }}
                        </span>
                        <div class="tc-description">
                            {{ timeData.minutes | pluralize('Minute') }}
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-3">
                    <div class="time-card">
                        <span class="tc-value">
                            {{ timeData.seconds | padTimeComponent }}
                        </span>
                        <div class="tc-description">
                            {{ timeData.seconds | pluralize('Second') }}
                        </div>
                    </div>
                </div>
            </div>
            <div v-else>
                Done!
            </div>

            <!-- Event Navigation -->
            <div class="row">
                <div class="offset-md-2 col-md-8">
                    <div class="text-right my-4">
                        <a class="btn btn-primary" data-toggle="modal" href="#addEventModal">Add</a>
                        <a class="btn btn-primary" data-toggle="collapse" href="#eventList">Show all</a>
                    </div>
                    <div class="text-left collapse" id="eventList">
                        <ul class="list-group">
                            <li v-for="event in events" @click="setActiveEvent(event)" class="list-group-item" v-bind:class="{ active: event == activeEvent }">
                                {{ event.name }} - {{ event.date }}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Add Event Modal -->
            <div class="modal fade" id="addEventModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Event</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form @submit="addEvent" id="addEventForm" class="text-left">
                                <div class="form-group">
                                    <label for="eventNameInput">Event name</label>
                                    <input type="text" class="form-control" id="eventNameInput" placeholder="Event name" v-model="eventName">
                                </div>
                                <div class="form-group">
                                    <label for="eventTimeInput">Event Time</label>
                                    <input type="datetime-local" class="form-control" id="eventTimeInput" placeholder="Event time" v-model="eventTime">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="submit" form="addEventForm" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.min.js"></script>

    <script>
        Vue.config.devtools = true;

        var app = new Vue({
            el: '#countdown',
            data: {
                loading: true,
                timeData: {},
                activeEvent: {},
                events: [],
                eventName: null,
                eventTime: null
            },
            created: function () {
                var self = this;

                var requestData = { action: "list" };
                $.post('api/', requestData, function (data) {
                    self.events = data;
                    self.activeEvent = data[0];

                    self.updateClock();
                    setInterval(self.updateClock, 1000);

                    self.loading = false;
                }, 'json');
            },
            filters: {
                pluralize: function (count, str) {
                    if (count == 1) {
                        return str;
                    }
                    return str + "s";
                },
                padTimeComponent: function (num) {
                    if (num.toString().length < 2) {
                        num = '0' + num;
                    }
                    return num;
                }
            },
            methods: {
                updateClock: function () {
                    this.timeData = getTimeRemaining(this.activeEvent.timestamp);
                },
                setActiveEvent: function (event) {
                    this.activeEvent = event;
                },
                addEvent: function (e) {
                    var self = this;

                    var requestData = {
                        action: "add",
                        eventName: this.eventName,
                        eventTime : this.eventTime
                    };
                    $.post('api/', requestData, function (data) {
                        self.eventName = null;
                        self.eventTime = null;

                        self.events.push(data);
                        self.activeEvent = data;

                        $('#addEventModal').modal('hide');
                        $('#eventList').slideDown();
                    }, 'json');

                    e.preventDefault();
                }
            }
        });

        function getTimeRemaining(endtime) {
            var now = Math.floor(new Date().getTime() / 1000);
            var difference = endtime - now;

            return {
                'total': difference,
                'seconds': Math.floor(difference % 60),
                'minutes': Math.floor((difference / 60) % 60),
                'hours': Math.floor((difference / (60 * 60)) % 24),
                'days': Math.floor(difference / (60 * 60 * 24))
            };
        }
    </script>
</body>
</html>
